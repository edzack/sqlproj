CREATE SCHEMA [Sales] AUTHORIZATION [dbo];
GO

CREATE TABLE [Sales].[Customer] (
	[CustomerID]    INT              IDENTITY (1, 1) NOT FOR REPLICATION NOT NULL,
	[PersonID]      INT              NULL,
	[StoreID]       INT              NULL,
	[TerritoryID]   INT              NULL,
	[SalesPersonID]	INT				 NULL,
	[ModifiedDate]  DATETIME         NOT NULL
);
GO

CREATE TABLE [Sales].[Store] (
	[BusinessEntityID] INT                                                NOT NULL,
	[Name]             NVARCHAR(50)                                       NOT NULL,
	[SalesPersonID]    INT                                                NULL,
	[CustomerID]	   INT                                                NULL,
	[ModifiedDate]     DATETIME                                           NOT NULL
);
GO

CREATE TABLE [Sales].[SalesPerson] (
	[SalesPersonID]	   INT              NOT NULL,
	[TerritoryID]      INT              NULL,
	[SalesQuota]       MONEY            NULL,
	[Bonus]            MONEY            NOT NULL,
	[CommissionPct]    SMALLMONEY       NOT NULL,
	[SalesYTD]         MONEY            NOT NULL,
	[SalesLastYear]    MONEY            NOT NULL,
	[ModifiedDate]     DATETIME         NOT NULL
);
GO

-- You cannot use:
-- 
-- CREATE ASSEMBLY [SqlProjAgg]
--	 AUTHORIZATION [dbo]
--	 FROM 'd:\src\github\sqlproj\samples\SqlProjAgg\SqlProjClr\bin\Debug\SqlProjClr.dll'
--	 WITH PERMISSION_SET = SAFE;
--
-- SQL70502: The assembly source is not valid. Only binary literals are allowed.
-- You need to use a assembly reference as shown in SqlProjAggRef instead

CREATE ASSEMBLY [SqlProjAgg]
	AUTHORIZATION [dbo]
	FROM 0x4D5A90000300000004000000FFFF0000B800000000000000400000000000000000000000000000000000000000000000000000000000000000000000800000000E1FBA0E00B409CD21B8014CCD21546869732070726F6772616D2063616E6E6F742062652072756E20696E20444F53206D6F64652E0D0D0A2400000000000000504500004C010300F64636510000000000000000E00002210B010B00000A00000006000000000000BE2800000020000000400000000000100020000000020000040000000000000004000000000000000080000000020000000000000300408500001000001000000000100000100000000000001000000000000000000000006C2800004F00000000400000B002000000000000000000000000000000000000006000000C000000342700001C0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000080000000000000000000000082000004800000000000000000000002E74657874000000C408000000200000000A000000020000000000000000000000000000200000602E72737263000000B00200000040000000040000000C0000000000000000000000000000400000402E72656C6F6300000C0000000060000000020000001000000000000000000000000000004000004200000000000000000000000000000000A02800000000000048000000020005003C210000F80500000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000360002730600000A7D010000042A0000133002002D00000001000011000F01280700000A16FE010A062D03002B1A027B010000040F01280800000A6F0900000A1F2C6F0A00000A262A5200027B01000004037B010000046F0B00000A262A0000133004004D00000002000011007E0C00000A0A027B010000042C13027B010000046F0D00000A16FE0216FE012B0117000C082D1A027B0100000416027B010000046F0D00000A17596F0E00000A0A06730F00000A0B2B00072A4E0002036F1000000A731100000A7D010000042A520003027B010000046F1200000A6F1300000A002A1E02281400000A2A000042534A4201000100000000000C00000076342E302E33303331390000000005006C0000001C020000237E0000880200004C02000023537472696E677300000000D40400000800000023555300DC040000100000002347554944000000EC0400000C01000023426C6F620000000000000002000001571702000900000000FA253300160000010000000E0000000200000001000000070000000400000001000000140000000400000002000000010000000200000000000A00010000000000060035002E000A00630048000600800074000A00BB00A6000600EA00E0000600FC00E0000600380125011F004C01000006007B015B0106009B015B010600C4012E000A00DA0148000A00FB01480006001E022E000000000001000000000001000100012010001900000005000100010001008E000A005020000000008600A1000E0001006020000000008600C500120001009920000000008600D00018000200B020000000008600D6001E000300092100000000E601F700230003001D2100000000E60109012900040032210000000086180F010E000500000001001501000001001B010000010021010000010023010200090039000F012F0049000F01350051000F010E0059000F010E0061000F013A0019000F010E0021000202A20021000D02A60019001702AA0019001702B00019001702BA0071002502C00019002B02C30019003602C70021000F01CD0029003F02A60019000F01CD0009003602A60031000901CD0009000F010E002E000B00D9002E001300E2002E001B00EB0043002B004000B600D200048000000000000000000000000000000000B9010000040000000000000000000000010025000000000004000000000000000000000001003C000000000000000000003C4D6F64756C653E0053716C50726F6A4167672E646C6C00436F6E636174656E617465006D73636F726C69620053797374656D004F626A6563740053797374656D2E44617461004D6963726F736F66742E53716C5365727665722E536572766572004942696E61727953657269616C697A650053797374656D2E5465787400537472696E674275696C64657200696E7465726D656469617465526573756C7400496E69740053797374656D2E446174612E53716C54797065730053716C537472696E6700416363756D756C617465004D65726765005465726D696E6174650053797374656D2E494F0042696E61727952656164657200526561640042696E617279577269746572005772697465002E63746F720076616C7565006F74686572007200770053797374656D2E446961676E6F73746963730044656275676761626C6541747472696275746500446562756767696E674D6F6465730053797374656D2E52756E74696D652E436F6D70696C6572536572766963657300436F6D70696C6174696F6E52656C61786174696F6E734174747269627574650052756E74696D65436F6D7061746962696C6974794174747269627574650053716C50726F6A4167670053657269616C697A61626C654174747269627574650053716C55736572446566696E656441676772656761746541747472696275746500466F726D6174006765745F49734E756C6C006765745F56616C756500417070656E6400537472696E6700456D707479006765745F4C656E67746800546F537472696E670052656164537472696E670000000003200000000000FAB29618F1C8DE499B4328153F7132510008B77A5C561934E0890306120D03200001052001011111052001011208042000111105200101121505200101121905200101112104200101080520010111356101000200000004005402124973496E76617269616E74546F4E756C6C73015402174973496E76617269616E74546F4475706C696361746573005402124973496E76617269616E74546F4F726465720054080B4D61784279746553697A65401F0000032000020320000E052001120D0E052001120D0303070102052001120D1C02060E032000080520020E0808042001010E0607030E1111020801000701000000000801000800000000001E01000100540216577261704E6F6E457863657074696F6E5468726F777301000000000000F646365100000000020000001C010000502700005009000052534453FD72ADE9AB738E428EA745A8E237CCAE01000000633A5C55736572735C67657274645C44726F70626F785C50726F6A656374735C53716C50726F6A4167675C53716C50726F6A4167675C6F626A5C44656275675C53716C50726F6A4167672E7064620000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000942800000000000000000000AE280000002000000000000000000000000000000000000000000000A0280000000000000000000000005F436F72446C6C4D61696E006D73636F7265652E646C6C0000000000FF25002000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100100000001800008000000000000000000000000000000100010000003000008000000000000000000000000000000100000000004800000058400000540200000000000000000000540234000000560053005F00560045005200530049004F004E005F0049004E0046004F0000000000BD04EFFE00000100000000000000000000000000000000003F000000000000000400000002000000000000000000000000000000440000000100560061007200460069006C00650049006E0066006F00000000002400040000005400720061006E0073006C006100740069006F006E00000000000000B004B4010000010053007400720069006E006700460069006C00650049006E0066006F0000009001000001003000300030003000300034006200300000002C0002000100460069006C0065004400650073006300720069007000740069006F006E000000000020000000300008000100460069006C006500560065007200730069006F006E000000000030002E0030002E0030002E003000000040000F00010049006E007400650072006E0061006C004E0061006D0065000000530071006C00500072006F006A004100670067002E0064006C006C00000000002800020001004C006500670061006C0043006F00700079007200690067006800740000002000000048000F0001004F0072006900670069006E0061006C00460069006C0065006E0061006D0065000000530071006C00500072006F006A004100670067002E0064006C006C0000000000340008000100500072006F006400750063007400560065007200730069006F006E00000030002E0030002E0030002E003000000038000800010041007300730065006D0062006C0079002000560065007200730069006F006E00000030002E0030002E0030002E003000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000C000000C03800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000;
GO

CREATE AGGREGATE [dbo].[Concatenate](@value NVARCHAR (4000))
	RETURNS NVARCHAR (4000)
	EXTERNAL NAME [SqlProjAgg].[Concatenate];
GO

CREATE VIEW vUsingAgg
AS
SELECT		scu.SalesPersonID, 
			dbo.Concatenate(sst.Name) AS ConcateName
FROM		Sales.Customer as scu 
INNER JOIN	Sales.Store as sst ON scu.CustomerID = sst.CustomerID
INNER JOIN	Sales.SalesPerson as spr ON scu.SalesPersonID = spr.SalesPersonID
WHERE		scu.SalesPersonID = 283
GROUP BY	scu.SalesPersonID
GO
